<!DOCTYPE html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>SteemRank</title>
    <meta property="title" content="SteemRank" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Space+Mono" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>


<body>

    <div class="content">
    
        <h1>Top authors by pending payout</h1>

        <div class="collection"></div>
    
    </div>



    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>

    <script type="text/javascript">

        $(window).on('load', function(){

            var itemHtmlBase = '\
                <a href="{profile_url}" target="_blank" class="collection-item avatar profile"> \
                    <img src="{profile_avatar}" class="circle"> \
                    <span class="title">@{username}</span> \
                    <div class="profile__data"> \
                        <p class="profile__data__main"> \
                            <span title="Pending payout"><i class="material-icons">monetization_on</i> {pending_payout}</span> \
                            <span title="Number of upvotes"><i class="material-icons">thumb_up</i> {upvotes}</span> \
                            <span title="Number of posts" class="profile__comments"><i class="fa fa-comments"></i>{posts}</span> \
                        </p> \
                        <p>Balance: {sbd_balance} | {steem_balance}</p> \
                    </div> \
                </a> \
            ';

            var ajax_data = {
                query: " \
                    SELECT TOP 50 \
                        Comments.author, \
                        SUM(Comments.pending_payout_value) as pending_payout, \
                        COUNT(*) as posts, \
                        SUM(Comments.net_votes) as upvotes, \
                        Accounts.sbd_balance, \
                        Accounts.balance  as steem_balance, \
                        Accounts.created \
                    FROM \
                        Comments \
                        INNER JOIN Accounts ON Comments.author = Accounts.name \
                    WHERE \
                        Comments.depth=0 AND \
                        Comments.created BETWEEN GETDATE()-7 AND GETDATE() \
                    GROUP BY Comments.author, Accounts.sbd_balance, Accounts.balance, Accounts.created \
                    ORDER BY SUM(Comments.pending_payout_value) DESC \
                ",
            }

            $.ajax({
                url: 'https://sql.steemhelpers.com/api',
                type: 'POST',
                data: JSON.stringify(ajax_data),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json'
            })
                .done(function(data) {

                    if(data['error']){
                        return;
                    }

                    data['rows'].forEach(function(row) {

                        var itemHtml = itemHtmlBase.replace('{username}', row['author']);
                        var itemHtml = itemHtml.replace('{profile_url}', 'https://steemit.com/@' + row['author']);
                        var itemHtml = itemHtml.replace('{profile_avatar}', 'https://steemitimages.com/u/' + row['author'] + '/avatar');

                        var itemHtml = itemHtml.replace('{pending_payout}', row['pending_payout']);
                        var itemHtml = itemHtml.replace('{posts}', row['posts']);
                        var itemHtml = itemHtml.replace('{upvotes}', row['upvotes']);
                        var itemHtml = itemHtml.replace('{sbd_balance}', row['sbd_balance']);
                        var itemHtml = itemHtml.replace('{steem_balance}', row['steem_balance']);

                        // var itemHtml = itemHtml.replace('{created}', row['created']);

                        $item = $(itemHtml);
                        $('.collection').append($item);

                    }); // forEach

                })
                .fail(function(data) {
                    Materialize.toast('Error!', 4000);
                });


        }); // $(window).on('load')


    </script>



</body>
</html>