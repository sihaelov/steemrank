<!DOCTYPE html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>SteemRank</title>
    <meta property="title" content="SteemRank" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Space+Mono" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>


<body>
    
    <div class="content-wrapper">


        <div class="sorters-wrapper">
            <h3>Sort by</h3>

            <div class="sorters">
                <div class="sorter__link active" sorter="pending_payout_value"> Pending payout </div>
                <div class="sorter__link" sorter="children"> Comments </div>
                <div class="sorter__link" sorter="net_votes"> Upvotes </div>
            </div>
        </div>

        <div class="content">

            <div class="card top-categories">
                <h1>Top categories</h1>
                <div class="center-align">
                    Loading...
                </div>
            </div>

            <h1>Top authors</h1>

            <div class="collection author-list"></div>

            <div id="loader" class="center-align" style="display: none;">
                <div class="preloader-wrapper big active">
                    <div class="spinner-layer spinner-blue-only">
                      <div class="circle-clipper left">
                        <div class="circle"></div>
                      </div><div class="gap-patch">
                        <div class="circle"></div>
                      </div><div class="circle-clipper right">
                        <div class="circle"></div>
                      </div>
                    </div>
                </div>
            </div>

        </div>
    
    </div>



    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>

    <script type="text/javascript">

        var itemHtmlBase = '\
            <div class="collection-item avatar profile"> \
                <a href="{profile_url}" target="_blank" class="profile-link"></a> \
                <img src="{profile_avatar}" class="circle"> \
                <span class="title">@{username}</span> \
                <div class="profile__data"> \
                    <p class="profile__data__main"> \
                        <span title="Pending payout"><i class="material-icons">monetization_on</i> {pending_payout_value}</span> \
                        <span title="Number of upvotes"><i class="material-icons">thumb_up</i> {net_votes}</span> \
                        <span title="Number of comments" class="profile__comments"><i class="fa fa-comments"></i>{children}</span> \
                    </p> \
                    <p>Balance: {sbd_balance} | {steem_balance}</p> \
                </div> \
                <p class="secondary-content profile__position">{profile__position}</p> \
            </div> \
        ';

        var sqlQueryBase = "\
            SELECT TOP 50 \
                Comments.author, \
                SUM(Comments.pending_payout_value) as pending_payout_value, \
                COUNT(*) as posts, \
                SUM(Comments.children) as children, \
                SUM(Comments.net_votes) as net_votes, \
                Accounts.sbd_balance, \
                Accounts.balance  as steem_balance, \
                Accounts.created \
            FROM \
                Comments \
                INNER JOIN Accounts ON Comments.author = Accounts.name \
            WHERE \
                Comments.depth=0 AND \
                Comments.created BETWEEN GETDATE()-7 AND GETDATE() \
            GROUP BY Comments.author, Accounts.sbd_balance, Accounts.balance, Accounts.created \
            HAVING SUM(Comments.{sorter}) < {lastProfileValue} \
            ORDER BY SUM(Comments.{sorter}) DESC \
        ";

        var sqlTopCategories = "\
            SELECT TOP 5 category, SUM(Comments.pending_payout_value) as sum_pending_payout_value \
            FROM Comments \
            WHERE depth=0 AND created BETWEEN GETDATE()-7 AND GETDATE() \
            GROUP BY category \
            ORDER BY sum_pending_payout_value DESC \
        ";

        var lastProfileValue = 999999;
        var lastProfileNumber = 1;

        var curentSorter = $('.sorter__link.active').attr('sorter');

        $(window).on('load', function(){

            loadData();
            loadTopCategories();

            var isLoading = false;

            $(window).scroll(function() {
                // if ($(document).height() - $(window).height() == $(window).scrollTop() && !isLoading) {
                if (($(window).scrollTop() + $(window).height() > $(document).height() - 100) && !isLoading) {
                    loadData();
                }
            });

            $('.sorter__link').click(function(e) {
                e.preventDefault();
                $('.sorter__link.active').removeClass('active');
                $(this).addClass('active');

                curentSorter = $(this).attr('sorter');
                lastProfileValue = 999999;
                lastProfileNumber = 1;

                $('.collection.author-list').html('');
                loadData();
            });

            function loadData() {

                isLoading = true;
                $('#loader').show();

                var sqlQuery = sqlQueryBase.replace('{lastProfileValue}', lastProfileValue);
                sqlQuery = sqlQuery.replace(/{sorter}/g, curentSorter);

                var ajaxData = {
                    query: sqlQuery,
                }

                $.ajax({
                    url: 'https://sql.steemhelpers.com/api',
                    type: 'POST',
                    data: JSON.stringify(ajaxData),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json'
                })
                    .done(function(data) {
                        insertData(data);
                        $('#loader').hide();
                        isLoading = false;
                    })
                    .fail(function(data) {
                        Materialize.toast('Error!', 4000);
                    });
            }

            function insertData(data) {
                if(data['error']){
                    return;
                }

                data['rows'].forEach(function(row) {

                    var itemHtml = itemHtmlBase.replace('{username}', row['author']);
                    var itemHtml = itemHtml.replace('{profile_url}', 'https://steemit.com/@' + row['author']);
                    var itemHtml = itemHtml.replace('{profile_avatar}', 'https://steemitimages.com/u/' + row['author'] + '/avatar');

                    var itemHtml = itemHtml.replace('{pending_payout_value}', row['pending_payout_value']);
                    var itemHtml = itemHtml.replace('{children}', row['children']);
                    var itemHtml = itemHtml.replace('{net_votes}', row['net_votes']);
                    var itemHtml = itemHtml.replace('{sbd_balance}', row['sbd_balance']);
                    var itemHtml = itemHtml.replace('{steem_balance}', row['steem_balance']);

                    // var itemHtml = itemHtml.replace('{created}', row['created']);
                    var itemHtml = itemHtml.replace('{profile__position}', lastProfileNumber);

                    $item = $(itemHtml);
                    $('.collection.author-list').append($item);

                    lastProfileValue = row[curentSorter];
                    lastProfileNumber += 1;
                }); // forEach
                
            } //insertData()

            function loadTopCategories() {

                var ajaxData = {
                    query: sqlTopCategories,
                }

                $.ajax({
                    url: 'https://sql.steemhelpers.com/api',
                    type: 'POST',
                    data: JSON.stringify(ajaxData),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json'
                })
                    .done(function(data) {
                        $('.top-categories > div').html('');

                        data['rows'].forEach(function(row) {
                            var $category = $('<div class="chip"></div>');
                            $category.text(row['category']);
                            $('.top-categories > div').append($category);
                        }); // forEach

                    })
                    .fail(function(data) {
                        Materialize.toast('Error!', 4000);
                    });

            }

        }); // $(window).on('load')

    </script>



</body>
</html>